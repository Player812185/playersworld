<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Панель администратора</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <section class="admin-panel">
    <h2>Панель администратора</h2>
    <label for="streamSelect">Выберите аудио-поток:</label>
    <select id="streamSelect">
      <option value="https://www.myinstants.com/media/sounds/alllah-habaaaaaaaaar.mp3">Поток 1</option>
      <option value="https://www.myinstants.com/media/sounds/du-bisch-erbarmlich-2.mp3">Поток 2</option>
      <option value="https://www.myinstants.com/media/sounds/leck-meine-fetten-eier-du_vryOfG3.mp3">Поток 3</option>
    </select>
    <button id="saveBtn">Запустить трансляцию</button>
    <p id="message"></p>
  </section>
  <script>
    /**
     * Инструкция по получению Personal Access Token:
     * 1. Зайдите на GitHub в Settings → Developer settings → Personal access tokens.
     * 2. Нажмите «Generate new token», выберите scope 'public_repo' (для публичного репо) или 'repo' (для приватного).
     * 3. Скопируйте токен и вставьте ниже.
     */
    const GITHUB_TOKEN = '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';  // вставьте ваш токен
    const OWNER = 'Player812185';      // ваш GitHub-логин
    const REPO = 'playersworld';       // имя репозитория для Pages
    const PATH = 'config.json';        // путь к файлу в корне

    const select = document.getElementById('streamSelect');
    const btn = document.getElementById('saveBtn');
    const msg = document.getElementById('message');
    let sha = '';

    async function getConfigSha() {
      const res = await fetch(
        `https://api.github.com/repos/${OWNER}/${REPO}/contents/${PATH}`,
        {
          headers: {
            Authorization: `Bearer ${GITHUB_TOKEN}`,
            Accept: 'application/vnd.github.v3+json'
          }
        }
      );
      if (res.status === 401) throw new Error('Unauthorized: проверьте токен/права доступа');
      const data = await res.json();
      sha = data.sha;
    }

    async function updateConfig(newUrl) {
      const content = btoa(JSON.stringify({ streamUrl: newUrl }, null, 2));
      const body = {
        message: 'Update streamUrl via admin page',
        content,
        sha
      };
      const res = await fetch(
        `https://api.github.com/repos/${OWNER}/${REPO}/contents/${PATH}`,
        {
          method: 'PUT',
          headers: {
            Authorization: `Bearer ${GITHUB_TOKEN}`,
            Accept: 'application/vnd.github.v3+json',
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(body)
        }
      );
      if (!res.ok) throw new Error(`Ошибка API GitHub: ${res.status}`);
      const data = await res.json();
      sha = data.content.sha;
    }

    btn.addEventListener('click', async () => {
      try {
        msg.textContent = '';
        await getConfigSha();
        await updateConfig(select.value);
        msg.textContent = 'Трансляция обновлена!';
      } catch (e) {
        console.error(e);
        msg.textContent = e.message;
      }
      setTimeout(() => msg.textContent = '', 5000);
    });
  </script>
</body>
</html>
